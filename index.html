<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Takara Karat Farmer</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Cabinet+Grotesk:wght@400;500;700;800;900&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #05080a;
    --surface: #090e12;
    --card: #0c1217;
    --border: #141e27;
    --border2: #1c2d3a;
    --green: #05f083;
    --green-dim: rgba(5,240,131,0.10);
    --gold: #f0b429;
    --gold-dim: rgba(240,180,41,0.10);
    --red: #f05252;
    --text: #b8cdd8;
    --text2: #6b8899;
    --white: #e8f4fc;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: 'Cabinet Grotesk', sans-serif; min-height: 100vh; }
  body::before { content: ''; position: fixed; top: -200px; left: 50%; transform: translateX(-50%); width: 800px; height: 400px; background: radial-gradient(ellipse, rgba(5,240,131,0.05) 0%, transparent 70%); pointer-events: none; z-index: 0; }
  body::after { content: ''; position: fixed; inset: 0; background-image: radial-gradient(circle, rgba(255,255,255,0.025) 1px, transparent 1px); background-size: 28px 28px; pointer-events: none; z-index: 0; }

  .wrap { max-width: 820px; margin: 0 auto; padding: 40px 24px 80px; position: relative; z-index: 1; }

  /* HEADER */
  .topbar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 48px; }
  .brand { display: flex; align-items: center; gap: 12px; }
  .brand svg { width: 40px; height: 40px; filter: drop-shadow(0 0 10px var(--green)); }
  .brand-text h1 { font-size: 1.35rem; font-weight: 900; color: var(--white); letter-spacing: -0.5px; }
  .brand-text p { font-family: 'DM Mono', monospace; font-size: 0.62rem; color: var(--text2); letter-spacing: 1.5px; text-transform: uppercase; margin-top: 2px; }
  .badge { display: flex; align-items: center; gap: 6px; background: var(--green-dim); border: 1px solid rgba(5,240,131,0.18); border-radius: 99px; padding: 5px 13px; font-family: 'DM Mono', monospace; font-size: 0.68rem; color: var(--green); }
  .dot { width: 6px; height: 6px; background: var(--green); border-radius: 50%; box-shadow: 0 0 6px var(--green); animation: pulse 2s ease-in-out infinite; }
  @keyframes pulse { 0%,100%{opacity:1}50%{opacity:0.3} }

  /* USER BAR */
  .userbar { display: none; align-items: center; gap: 12px; }
  .userbar .email { font-family: 'DM Mono', monospace; font-size: 0.72rem; color: var(--text2); }
  .btn-logout { background: transparent; border: 1px solid var(--border2); color: var(--text2); border-radius: 8px; padding: 6px 14px; font-family: 'Cabinet Grotesk', sans-serif; font-size: 0.78rem; cursor: pointer; transition: all 0.15s; }
  .btn-logout:hover { border-color: var(--red); color: var(--red); }

  /* CARDS */
  .card { background: var(--card); border: 1px solid var(--border); border-radius: 20px; margin-bottom: 16px; overflow: hidden; }
  .card-head { padding: 20px 24px 0; display: flex; align-items: center; gap: 10px; }
  .card-icon { width: 30px; height: 30px; background: var(--green-dim); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px; }
  .card-head h2 { font-size: 0.82rem; font-weight: 700; color: var(--white); }
  .card-head span { font-family: 'DM Mono', monospace; font-size: 0.62rem; color: var(--text2); letter-spacing: 0.8px; text-transform: uppercase; }
  .card-body { padding: 20px 24px 24px; }

  /* FORMS */
  .field { margin-bottom: 13px; }
  .field label { display: flex; justify-content: space-between; align-items: center; font-family: 'DM Mono', monospace; font-size: 0.66rem; color: var(--text2); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 7px; }
  .field label a { color: var(--green); text-decoration: none; font-size: 0.62rem; text-transform: none; letter-spacing: 0; cursor: pointer; }
  input { width: 100%; background: var(--surface); border: 1px solid var(--border2); border-radius: 11px; padding: 12px 15px; font-family: 'DM Mono', monospace; font-size: 0.86rem; color: var(--white); outline: none; transition: border-color 0.15s, box-shadow 0.15s; }
  input:focus { border-color: var(--green); box-shadow: 0 0 0 3px rgba(5,240,131,0.07); }
  input[type="password"] { letter-spacing: 3px; }
  .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .errmsg { font-family: 'DM Mono', monospace; font-size: 0.7rem; color: var(--red); margin-top: 8px; min-height: 18px; }

  /* TABS */
  .tabs { display: flex; gap: 4px; background: var(--surface); border-radius: 12px; padding: 4px; margin-bottom: 20px; }
  .tab { flex: 1; padding: 9px; text-align: center; border-radius: 9px; font-size: 0.84rem; font-weight: 700; cursor: pointer; transition: all 0.15s; color: var(--text2); border: none; background: transparent; }
  .tab.active { background: var(--card); color: var(--white); box-shadow: 0 1px 8px rgba(0,0,0,0.3); }

  /* BUTTONS */
  .btn { width: 100%; padding: 14px; border: none; border-radius: 13px; font-family: 'Cabinet Grotesk', sans-serif; font-size: 0.95rem; font-weight: 800; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden; }
  .btn::before { content: ''; position: absolute; inset: 0; background: linear-gradient(135deg,rgba(255,255,255,0.12) 0%,transparent 60%); pointer-events: none; }
  .btn-green { background: var(--green); color: #031a0e; }
  .btn-green:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 6px 24px rgba(5,240,131,0.3); }
  .btn-green:disabled { background: var(--border2); color: var(--text2); cursor: not-allowed; transform: none; box-shadow: none; }
  .btn-outline { background: transparent; border: 1px solid rgba(240,82,82,0.3); color: var(--red); }
  .btn-outline:hover:not(:disabled) { background: rgba(240,82,82,0.07); border-color: var(--red); }
  .btn-outline:disabled { opacity: 0.3; cursor: not-allowed; }
  .btn-ghost { background: var(--green-dim); border: 1px solid rgba(5,240,131,0.2); color: var(--green); display: none; }
  .btn-ghost:hover { background: rgba(5,240,131,0.15); }

  /* WALLET BOX */
  .wallet-box { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 18px 20px; margin-bottom: 18px; }
  .wallet-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
  .wallet-row:last-child { margin-bottom: 0; }
  .wallet-label { font-family: 'DM Mono', monospace; font-size: 0.66rem; color: var(--text2); text-transform: uppercase; letter-spacing: 1px; }
  .wallet-val { font-family: 'DM Mono', monospace; font-size: 0.88rem; color: var(--white); }
  .wallet-val.green { color: var(--green); font-size: 1.05rem; font-weight: 500; }
  .wallet-addr { font-family: 'DM Mono', monospace; font-size: 0.72rem; color: var(--text2); word-break: break-all; }
  .copy-btn { background: var(--green-dim); border: 1px solid rgba(5,240,131,0.18); color: var(--green); border-radius: 6px; padding: 3px 10px; font-size: 0.68rem; cursor: pointer; font-family: 'DM Mono', monospace; transition: all 0.15s; white-space: nowrap; }
  .copy-btn:hover { background: rgba(5,240,131,0.18); }

  /* PREVIEW */
  .preview-bar { display: grid; grid-template-columns: repeat(3,1fr); gap: 10px; margin: 14px 0; }
  .prev-item { background: var(--surface); border: 1px solid var(--border); border-radius: 11px; padding: 13px; text-align: center; }
  .prev-val { font-family: 'DM Mono', monospace; font-size: 1rem; font-weight: 500; color: var(--white); margin-bottom: 3px; }
  .prev-val.g { color: var(--green); }
  .prev-val.y { color: var(--gold); }
  .prev-lbl { font-family: 'DM Mono', monospace; font-size: 0.58rem; color: var(--text2); text-transform: uppercase; letter-spacing: 1px; }

  /* FEE ROW */
  .fee-row { display: flex; align-items: center; justify-content: space-between; background: var(--gold-dim); border: 1px solid rgba(240,180,41,0.18); border-radius: 11px; padding: 13px 16px; margin-bottom: 16px; }
  .fee-left { font-size: 0.82rem; color: var(--text); }
  .fee-left small { display: block; font-family: 'DM Mono', monospace; font-size: 0.62rem; color: var(--text2); margin-top: 2px; }
  .fee-right { font-family: 'DM Mono', monospace; font-size: 1.1rem; color: var(--gold); font-weight: 500; }

  /* PROGRESS */
  #prog-panel { display: none; }
  .sess-header { padding: 18px 24px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
  .sess-title { display: flex; align-items: center; gap: 9px; font-weight: 700; color: var(--white); font-size: 0.9rem; }
  .spinner { width: 16px; height: 16px; border: 2px solid var(--border2); border-top-color: var(--green); border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin{to{transform:rotate(360deg)}}
  .sess-addr { font-family: 'DM Mono', monospace; font-size: 0.68rem; color: var(--text2); }
  .stats-row { display: grid; grid-template-columns: repeat(4,1fr); border-top: 1px solid var(--border); }
  .stat-box { padding: 16px 18px; border-right: 1px solid var(--border); }
  .stat-box:last-child { border-right: none; }
  .stat-box .v { font-family: 'DM Mono', monospace; font-size: 1rem; font-weight: 500; color: var(--white); margin-bottom: 3px; }
  .stat-box .v.g{color:var(--green)} .stat-box .v.r{color:var(--red)} .stat-box .v.y{color:var(--gold)}
  .stat-box .l { font-family: 'DM Mono', monospace; font-size: 0.58rem; color: var(--text2); text-transform: uppercase; letter-spacing: 1px; }
  .prog-wrap { padding: 18px 24px 0; }
  .prog-track { background: var(--surface); border: 1px solid var(--border); border-radius: 99px; height: 5px; overflow: hidden; margin-bottom: 7px; }
  .prog-fill { height: 100%; width: 0%; background: linear-gradient(90deg,var(--green),#00d4ff); border-radius: 99px; transition: width 0.5s ease; box-shadow: 0 0 10px rgba(5,240,131,0.4); }
  .prog-labels { display: flex; justify-content: space-between; font-family: 'DM Mono', monospace; font-size: 0.62rem; color: var(--text2); }
  .term-wrap { padding: 14px 24px 20px; }
  .terminal { background: #020406; border: 1px solid var(--border); border-radius: 12px; padding: 14px 16px; height: 260px; overflow-y: auto; font-family: 'DM Mono', monospace; font-size: 0.73rem; line-height: 1.75; }
  .terminal::-webkit-scrollbar{width:3px} .terminal::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}
  .l{color:var(--text);display:block}.l.ok{color:var(--green)}.l.er{color:var(--red)}.l.in{color:var(--gold)}.l.dm{color:var(--text2)}
  .cur{display:inline-block;width:7px;height:12px;background:var(--green);border-radius:1px;animation:blink 1s step-end infinite;vertical-align:text-bottom;margin-left:1px;box-shadow:0 0 5px var(--green);}
  @keyframes blink{50%{opacity:0}}
  .acts { display: flex; gap: 10px; padding: 0 24px 22px; }
  .acts .btn { padding: 12px; font-size: 0.86rem; }
  .done-box { margin: 0 24px 22px; background: var(--green-dim); border: 1px solid rgba(5,240,131,0.22); border-radius: 12px; padding: 18px 22px; display: none; text-align: center; }
  .done-box h3 { color: var(--green); font-size: 1.1rem; margin-bottom: 5px; }
  .done-box p { font-family: 'DM Mono', monospace; font-size: 0.7rem; color: var(--text2); line-height: 1.7; }

  /* HISTORY */
  .hist-row { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr; gap: 8px; padding: 11px 0; border-bottom: 1px solid var(--border); font-family: 'DM Mono', monospace; font-size: 0.7rem; align-items: center; }
  .hist-row:last-child { border-bottom: none; }
  .hist-head { color: var(--text2); font-size: 0.62rem; text-transform: uppercase; letter-spacing: 0.8px; }
  .hist-val { color: var(--text); }
  .hist-val.ok { color: var(--green); }

  /* NOTICE */
  .notice { display: flex; gap: 10px; background: rgba(240,82,82,0.06); border: 1px solid rgba(240,82,82,0.15); border-radius: 11px; padding: 12px 14px; font-size: 0.78rem; color: #fca5a5; line-height: 1.5; margin-bottom: 14px; }

  /* PAGES */
  .page { display: none; }
  .page.active { display: block; }

  @media(max-width:580px){
    .two-col{grid-template-columns:1fr}
    .stats-row{grid-template-columns:repeat(2,1fr)}
    .stat-box:nth-child(2){border-right:none}
    .preview-bar{grid-template-columns:1fr 1fr}
    .topbar{flex-direction:column;align-items:flex-start;gap:10px}
    .hist-row{grid-template-columns:1fr 1fr 1fr}
  }

  /* PRIVATE KEY MODAL */
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; display: flex; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(4px); }
  .modal { background: var(--card); border: 1px solid rgba(245,197,66,0.3); border-radius: 20px; padding: 28px; max-width: 500px; width: 100%; box-shadow: 0 0 60px rgba(240,180,41,0.15); }
  .modal h2 { font-size: 1.1rem; font-weight: 900; color: var(--white); margin-bottom: 6px; }
  .modal .sub { font-family: 'DM Mono', monospace; font-size: 0.72rem; color: var(--text2); margin-bottom: 18px; line-height: 1.6; }
  .modal .warn-box { background: rgba(240,82,82,0.08); border: 1px solid rgba(240,82,82,0.25); border-radius: 11px; padding: 13px 15px; margin-bottom: 18px; font-size: 0.78rem; color: #fca5a5; line-height: 1.6; }
  .pk-box { background: var(--surface); border: 1px solid var(--border2); border-radius: 11px; padding: 14px 16px; font-family: 'DM Mono', monospace; font-size: 0.72rem; color: var(--green); word-break: break-all; line-height: 1.8; margin-bottom: 14px; position: relative; }
  .modal .checkbox-row { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 18px; cursor: pointer; }
  .modal .checkbox-row input[type=checkbox] { width: 18px; height: 18px; flex-shrink: 0; margin-top: 2px; accent-color: var(--green); cursor: pointer; }
  .modal .checkbox-row span { font-size: 0.8rem; color: var(--text); line-height: 1.5; }
  .btn-copy-pk { width: 100%; padding: 11px; background: var(--green-dim); border: 1px solid rgba(5,240,131,0.25); color: var(--green); border-radius: 10px; font-family: 'Cabinet Grotesk', sans-serif; font-weight: 700; font-size: 0.88rem; cursor: pointer; margin-bottom: 10px; transition: all 0.15s; }
  .btn-copy-pk:hover { background: rgba(5,240,131,0.18); }
  .btn-continue { width: 100%; padding: 13px; background: var(--green); color: #031a0e; border: none; border-radius: 12px; font-family: 'Cabinet Grotesk', sans-serif; font-weight: 800; font-size: 0.95rem; cursor: pointer; transition: all 0.2s; }
  .btn-continue:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(5,240,131,0.3); }
  .btn-continue:disabled { background: var(--border2); color: var(--text2); cursor: not-allowed; transform: none; }

</style>
</head>
<body>
<div class="wrap">

  <!-- TOPBAR -->
  <div class="topbar">
    <div class="brand">
      <svg viewBox="0 0 40 40" fill="none">
        <polygon points="20,3 37,13 37,27 20,37 3,27 3,13" fill="rgba(5,240,131,0.12)" stroke="#05f083" stroke-width="1.4"/>
        <polygon points="20,9 31,15 31,25 20,31 9,25 9,15" fill="rgba(5,240,131,0.07)" stroke="#05f083" stroke-width="0.7" opacity="0.5"/>
        <polygon points="20,15 27,19 27,23 20,27 13,23 13,19" fill="rgba(5,240,131,0.18)"/>
      </svg>
      <div class="brand-text">
        <h1>Karat Farmer</h1>
        <p>Sei Network ¬∑ Symphony</p>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:10px">
      <div class="userbar" id="userbar">
        <span class="email" id="user-email"></span>
        <button class="btn-logout" onclick="logout()">Sign out</button>
      </div>
      <div class="badge"><div class="dot"></div>Mainnet</div>
    </div>
  </div>

  <!-- AUTH PAGE -->
  <div class="page active" id="page-auth">
    <div class="card" style="max-width:440px;margin:0 auto">
      <div class="card-body" style="padding-top:24px">
        <div class="tabs">
          <button class="tab active" id="tab-login" onclick="switchTab('login')">Sign In</button>
          <button class="tab" id="tab-reg" onclick="switchTab('register')">Create Account</button>
        </div>

        <!-- LOGIN -->
        <div id="form-login">
          <div class="field">
            <label>Email</label>
            <input type="email" id="l-email" placeholder="you@example.com">
          </div>
          <div class="field">
            <label>Password</label>
            <input type="password" id="l-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')doLogin()">
          </div>
          <div class="errmsg" id="l-err"></div>
          <button class="btn btn-green" style="margin-top:8px" onclick="doLogin()" id="l-btn">Sign In</button>
        </div>

        <!-- REGISTER -->
        <div id="form-reg" style="display:none">
          <div class="notice">üîê We generate a secure Sei wallet for you automatically. No seed phrases needed.</div>
          <div class="field" id="invite-field" style="display:none">
            <label>Invite Code</label>
            <input type="text" id="r-invite" placeholder="Enter your invite code" style="text-transform:uppercase;letter-spacing:2px">
          </div>
          <div class="field">
            <label>Email</label>
            <input type="email" id="r-email" placeholder="you@example.com">
          </div>
          <div class="field">
            <label>Password <span style="font-size:0.62rem;letter-spacing:0;text-transform:none;color:var(--text2)">min 6 chars</span></label>
            <input type="password" id="r-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
          </div>
          <div class="field">
            <label>Confirm Password</label>
            <input type="password" id="r-pass2" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')doRegister()">
          </div>
          <div class="errmsg" id="r-err"></div>
          <button class="btn btn-green" style="margin-top:8px" onclick="doRegister()" id="r-btn">Create Account & Wallet</button>
        </div>
      </div>
    </div>
  </div>

  <!-- DASHBOARD PAGE -->
  <div class="page" id="page-dash">

    <!-- Wallet Card -->
    <div class="card">
      <div class="card-head">
        <div class="card-icon">üí≥</div>
        <div><h2>Your Farming Wallet</h2><span>Auto-generated ¬∑ Sei EVM</span></div>
      </div>
      <div class="card-body">
        <div class="wallet-box">
          <div class="wallet-row">
            <div>
              <div class="wallet-label" style="margin-bottom:5px">Wallet Address</div>
              <div class="wallet-addr" id="w-addr">‚Äî</div>
            </div>
            <button class="copy-btn" onclick="copyAddr()">Copy</button>
          </div>
          <div style="height:1px;background:var(--border);margin:12px 0"></div>
          <div class="wallet-row">
            <div><div class="wallet-label">USDC Balance</div><div class="wallet-val green" id="w-usdc">$‚Äî</div></div>
            <div style="text-align:right"><div class="wallet-label">SEI Balance</div><div class="wallet-val" id="w-sei">‚Äî</div></div>
          </div>
        </div>
        <p style="font-family:'DM Mono',monospace;font-size:0.7rem;color:var(--text2);line-height:1.6">
          Fund your wallet by sending <strong style="color:var(--white)">USDC</strong> to the address above on the Sei EVM network. Also send a small amount of <strong style="color:var(--white)">SEI</strong> for gas fees (~0.5 SEI is enough).
        </p>
      </div>
    </div>

    <!-- Config Card -->
    <div class="card" id="cfg-card">
      <div class="card-head">
        <div class="card-icon">‚öôÔ∏è</div>
        <div><h2>Start Farming Session</h2><span>USDC ‚Üî USDY via Symphony</span></div>
      </div>
      <div class="card-body">
        <div class="two-col">
          <div class="field">
            <label>Swap Amount (USDC)</label>
            <input type="number" id="amount" value="150" min="10" max="500" step="10" oninput="updatePreview()">
          </div>
          <div class="field">
            <label>Number of Cycles</label>
            <input type="number" id="cycles" value="150" min="10" max="500" step="10" oninput="updatePreview()">
          </div>
        </div>
        <div class="preview-bar">
          <div class="prev-item"><div class="prev-val g" id="pv-vol">$22,500</div><div class="prev-lbl">Volume</div></div>
          <div class="prev-item"><div class="prev-val" id="pv-time">~32 min</div><div class="prev-lbl">Est. Time</div></div>
          <div class="prev-item"><div class="prev-val y" id="pv-slip">~$0.30</div><div class="prev-lbl">Est. Slippage</div></div>
        </div>
        <div class="fee-row">
          <div class="fee-left">Service Fee<small>$0.01 per swap ¬∑ deducted at end</small></div>
          <div class="fee-right" id="pv-fee">$1.50</div>
        </div>
        <button class="btn btn-green" id="launch-btn" onclick="startSession()">‚ö° Launch Farming Session</button>
      </div>
    </div>

    <!-- Progress Panel -->
    <div id="prog-panel">
      <div class="card">
        <div class="sess-header">
          <div class="sess-title"><div class="spinner" id="spinner"></div>Session Running</div>
          <div class="sess-addr" id="sess-addr"></div>
        </div>
        <div class="stats-row">
          <div class="stat-box"><div class="v g" id="s-cyc">0/0</div><div class="l">Cycles</div></div>
          <div class="stat-box"><div class="v" id="s-bal">$‚Äî</div><div class="l">USDC Balance</div></div>
          <div class="stat-box"><div class="v r" id="s-slip">$0.00</div><div class="l">Slippage</div></div>
          <div class="stat-box"><div class="v y" id="s-fee">$0.00</div><div class="l">Service Fee</div></div>
        </div>
        <div class="prog-wrap">
          <div class="prog-track"><div class="prog-fill" id="prog-fill"></div></div>
          <div class="prog-labels"><span id="prog-pct">0%</span><span id="prog-eta">‚Äî</span></div>
        </div>
        <div class="term-wrap">
          <div class="terminal" id="terminal"><span class="l dm">// Connecting...</span><span class="cur"></span></div>
        </div>
        <div class="done-box" id="done-box"><h3>üéâ Session Complete</h3><p id="done-txt"></p></div>
        <div class="acts">
          <button class="btn btn-outline" id="stop-btn" onclick="stopSession()">‚õî Stop</button>
          <button class="btn btn-ghost" id="new-btn" onclick="newSession()">Ôºã New Session</button>
        </div>
      </div>
    </div>

    <!-- History -->
    <div class="card" id="hist-card">
      <div class="card-head">
        <div class="card-icon">üìä</div>
        <div><h2>Session History</h2><span>Last 20 runs</span></div>
      </div>
      <div class="card-body" id="hist-body">
        <div style="font-family:'DM Mono',monospace;font-size:0.72rem;color:var(--text2)">No sessions yet.</div>
      </div>
    </div>

  </div><!-- /page-dash -->


  <!-- PRIVATE KEY MODAL -->
  <div class="modal-overlay" id="pk-modal" style="display:none">
    <div class="modal">
      <h2>üîë Save Your Private Key</h2>
      <p class="sub">This is the only time we will show you your private key. Save it somewhere safe ‚Äî you can use it to access your wallet from any other app.</p>
      <div class="warn-box">
        ‚ö†Ô∏è <strong>Never share this with anyone.</strong> Anyone with this key has full access to your wallet and funds.
      </div>
      <div class="pk-box" id="pk-display">‚Äî</div>
      <button class="btn-copy-pk" onclick="copyPK()">üìã Copy Private Key</button>
      <label class="checkbox-row">
        <input type="checkbox" id="pk-confirm" onchange="document.getElementById('pk-continue').disabled=!this.checked">
        <span>I have saved my private key somewhere safe and understand I cannot retrieve it again.</span>
      </label>
      <button class="btn-continue" id="pk-continue" disabled onclick="closePKModal()">Continue to Dashboard ‚Üí</button>
    </div>
  </div>

</div>

<script>
  let TOKEN = localStorage.getItem('kf_token') || null;
  let SESSION_TOKEN = null, WS = null, TOTAL_CYCLES = 0, START_TIME = null;

  // ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function switchTab(t) {
    document.getElementById('form-login').style.display = t==='login'?'':'none';
    document.getElementById('form-reg').style.display   = t==='register'?'':'none';
    document.getElementById('tab-login').classList.toggle('active', t==='login');
    document.getElementById('tab-reg').classList.toggle('active', t==='register');
    if (t === 'register') checkInviteRequired();
  }

  async function checkInviteRequired() {
    try {
      const r = await fetch(BACKEND + '/api/invite-required');
      const d = await r.json();
      document.getElementById('invite-field').style.display = d.required ? '' : 'none';
    } catch {}
  }

  async function doLogin() {
    const email = document.getElementById('l-email').value.trim();
    const pass  = document.getElementById('l-pass').value;
    const btn   = document.getElementById('l-btn');
    document.getElementById('l-err').textContent = '';
    btn.disabled = true; btn.textContent = 'Signing in...';
    try {
      const r = await api('/api/login', { email, password: pass });
      TOKEN = r.token;
      localStorage.setItem('kf_token', TOKEN);
      localStorage.setItem('kf_email', email);
      showDash(email);
    } catch(e) {
      document.getElementById('l-err').textContent = e.message;
    }
    btn.disabled = false; btn.textContent = 'Sign In';
  }

  async function doRegister() {
    const email  = document.getElementById('r-email').value.trim();
    const pass   = document.getElementById('r-pass').value;
    const pass2  = document.getElementById('r-pass2').value;
    const invite = document.getElementById('r-invite').value.trim();
    const btn    = document.getElementById('r-btn');
    document.getElementById('r-err').textContent = '';
    if (pass !== pass2) { document.getElementById('r-err').textContent = 'Passwords do not match'; return; }
    btn.disabled = true; btn.textContent = 'Creating wallet...';
    try {
      const r = await api('/api/register', { email, password: pass, inviteCode: invite });
      TOKEN = r.token;
      localStorage.setItem('kf_token', TOKEN);
      localStorage.setItem('kf_email', email);
      // Show private key modal before going to dashboard
      if (r.showOnce && r.privateKey) {
        showPKModal(r.privateKey, email);
      } else {
        showDash(email);
      }
    } catch(e) {
      document.getElementById('r-err').textContent = e.message;
    }
    btn.disabled = false; btn.textContent = 'Create Account & Wallet';
  }

  function logout() {
    localStorage.removeItem('kf_token');
    localStorage.removeItem('kf_email');
    TOKEN = null;
    document.getElementById('page-auth').classList.add('active');
    document.getElementById('page-dash').classList.remove('active');
    document.getElementById('userbar').style.display = 'none';
  }

  // ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function showDash(email) {
    document.getElementById('page-auth').classList.remove('active');
    document.getElementById('page-dash').classList.add('active');
    document.getElementById('userbar').style.display = 'flex';
    document.getElementById('user-email').textContent = email || localStorage.getItem('kf_email') || '';
    loadWallet();
    loadHistory();
    updatePreview();
  }

  async function loadWallet() {
    try {
      const r = await apiAuth('/api/wallet');
      document.getElementById('w-addr').textContent = r.address;
      document.getElementById('w-usdc').textContent = '$' + r.usdc;
      document.getElementById('w-sei').textContent  = r.sei + ' SEI';
    } catch {}
  }

  async function loadHistory() {
    try {
      const rows = await apiAuth('/api/history');
      const body = document.getElementById('hist-body');
      if (!rows.length) { body.innerHTML = '<div style="font-family:\'DM Mono\',monospace;font-size:0.72rem;color:var(--text2)">No sessions yet.</div>'; return; }
      body.innerHTML = `
        <div class="hist-row">
          <span class="hist-head">Date</span>
          <span class="hist-head">Cycles</span>
          <span class="hist-head">Volume</span>
          <span class="hist-head">Slippage</span>
          <span class="hist-head">Fee</span>
        </div>
        ${rows.map(r => `
        <div class="hist-row">
          <span class="hist-val">${new Date(r.created_at*1000).toLocaleDateString()}</span>
          <span class="hist-val ok">${r.completed}/${r.cycles}</span>
          <span class="hist-val">$${(r.completed*r.amount).toLocaleString()}</span>
          <span class="hist-val">$${(r.start_bal-r.end_bal).toFixed(3)}</span>
          <span class="hist-val">$${r.fee_paid.toFixed(2)}</span>
        </div>`).join('')}`;
    } catch {}
  }

  function copyAddr() {
    const addr = document.getElementById('w-addr').textContent;
    navigator.clipboard.writeText(addr).then(() => {
      const btn = document.querySelector('.copy-btn');
      btn.textContent = 'Copied!';
      setTimeout(() => btn.textContent = 'Copy', 1500);
    });
  }

  // ‚îÄ‚îÄ PREVIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function updatePreview() {
    const c = parseInt(document.getElementById('cycles')?.value) || 0;
    const a = parseFloat(document.getElementById('amount')?.value) || 0;
    document.getElementById('pv-vol').textContent  = '$' + (c*a).toLocaleString();
    document.getElementById('pv-time').textContent = '~' + Math.round(c*13/60) + ' min';
    document.getElementById('pv-slip').textContent = '~$' + (c*0.002).toFixed(2);
    document.getElementById('pv-fee').textContent  = '$' + (c*0.01).toFixed(2);
    document.getElementById('s-fee').textContent   = '$' + (c*0.01).toFixed(2);
  }

  // ‚îÄ‚îÄ BOT SESSION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function startSession() {
    const cycles = parseInt(document.getElementById('cycles').value);
    const amount = parseFloat(document.getElementById('amount').value);
    if (!cycles || !amount) return;

    const btn = document.getElementById('launch-btn');
    btn.disabled = true; btn.textContent = 'Starting...';

    try {
      const r = await apiAuth('/api/start', { cycles, amount });
      SESSION_TOKEN = r.sessionToken;
      TOTAL_CYCLES  = cycles;
      START_TIME    = Date.now();

      document.getElementById('cfg-card').style.display  = 'none';
      document.getElementById('prog-panel').style.display = 'block';
      document.getElementById('s-cyc').textContent = '0 / ' + cycles;
      document.getElementById('sess-addr').textContent = r.address.slice(0,6)+'¬∑¬∑¬∑'+r.address.slice(-4);


      WS = new WebSocket(WS_BACKEND + '?session=' + SESSION_TOKEN + '&token=' + TOKEN);
      WS.onopen = () => {
        WS.send(JSON.stringify({ type:'init', cycles, amount }));
        clearTerm(); tlog('üîó Session started...','in');
      };
      WS.onmessage = e => handle(JSON.parse(e.data));
      WS.onclose   = () => tlog('Connection closed','dm');
      WS.onerror   = () => tlog('‚ö† Connection error','er');
    } catch(e) {
      alert(e.message);
      btn.disabled = false; btn.textContent = '‚ö° Launch Farming Session';
    }
  }

  function handle(msg) {
    switch(msg.type) {
      case 'started':
        tlog(`üí∞ Wallet: ${msg.address}`, 'in');
        tlog(`‚öôÔ∏è  ${msg.cycles} cycles √ó $${msg.amount} ¬∑ fee $${msg.totalFee}`, 'in');
        break;
      case 'log':
        const ok=msg.msg.includes('‚úÖ'),er=msg.msg.includes('‚ùå')||msg.msg.includes('‚ö†'),
              in_=msg.msg.includes('üí∞')||msg.msg.includes('‚öôÔ∏è')||msg.msg.includes('üéâ')||msg.msg.includes('üíµ')||msg.msg.includes('üìä');
        tlog(msg.msg, ok?'ok':er?'er':in_?'in':''); break;
      case 'cycle':
        const pct=Math.round((msg.current/msg.total)*100);
        document.getElementById('prog-fill').style.width=pct+'%';
        document.getElementById('prog-pct').textContent=pct+'%';
        document.getElementById('s-cyc').textContent=msg.current+' / '+msg.total;
        if(START_TIME&&msg.current>0){const el=(Date.now()-START_TIME)/1000,pc=el/msg.current,rem=Math.round(pc*(msg.total-msg.current));document.getElementById('prog-eta').textContent=rem>60?Math.round(rem/60)+'m left':rem+'s left';}
        break;
      case 'progress':
        document.getElementById('s-bal').textContent='$'+msg.balance;
        document.getElementById('s-slip').textContent='$'+msg.lost; break;
      case 'done':
        document.getElementById('prog-fill').style.width='100%';
        document.getElementById('prog-pct').textContent='100%';
        document.getElementById('prog-eta').textContent='Done';
        document.getElementById('s-cyc').textContent=msg.completedCycles+' / '+TOTAL_CYCLES;
        document.getElementById('s-bal').textContent='$'+msg.endBalance;
        document.getElementById('s-slip').textContent='$'+msg.slippage;
        document.getElementById('s-fee').textContent='$'+msg.fee;
        document.getElementById('spinner').style.display='none';
        document.getElementById('stop-btn').style.display='none';
        document.getElementById('new-btn').style.display='flex';
        document.getElementById('done-box').style.display='block';
        document.getElementById('done-txt').textContent=`${msg.completedCycles} cycles ¬∑ slippage $${msg.slippage} ¬∑ fee $${msg.fee}`;
        loadHistory(); loadWallet(); break;
      case 'error':
        tlog('‚ùå '+msg.msg,'er'); break;
    }
  }

  async function stopSession() {
    if(!SESSION_TOKEN) return;
    await apiAuth('/api/stop/'+SESSION_TOKEN, null, 'POST');
    tlog('‚õî Stop requested...','er');
    document.getElementById('stop-btn').disabled=true;
  }

  function newSession() {
    document.getElementById('cfg-card').style.display='';
    document.getElementById('prog-panel').style.display='none';
    document.getElementById('done-box').style.display='none';
    document.getElementById('spinner').style.display='';
    document.getElementById('stop-btn').style.display='';
    document.getElementById('stop-btn').disabled=false;
    document.getElementById('new-btn').style.display='none';
    document.getElementById('prog-fill').style.width='0%';
    document.getElementById('launch-btn').disabled=false;
    document.getElementById('launch-btn').textContent='‚ö° Launch Farming Session';
    SESSION_TOKEN=null; WS=null; START_TIME=null;
    loadWallet();
  }

  // ‚îÄ‚îÄ TERMINAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function tlog(msg,cls=''){const t=document.getElementById('terminal');const c=t.querySelector('.cur');if(c)c.remove();const s=document.createElement('span');s.className='l '+cls;s.textContent=msg;t.appendChild(s);const cur=document.createElement('span');cur.className='cur';t.appendChild(cur);t.scrollTop=t.scrollHeight;}
  function clearTerm(){document.getElementById('terminal').innerHTML='<span class="cur"></span>';}

  // ‚îÄ‚îÄ BACKEND CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Your Vultr backend URL ‚Äî change this after deploying to Vultr
const BACKEND = '';
const WS_BACKEND = 'wss://karatfarmer.ddns.net';
  
  // ‚îÄ‚îÄ API HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function api(url, body) {
    const r = await fetch(BACKEND + url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body), credentials:'include' });
    const d = await r.json();
    if (!r.ok) throw new Error(d.error || 'Request failed');
    return d;
  }
  async function apiAuth(url, body=null, method=null) {
    const m = method || (body ? 'POST' : 'GET');
    const r = await fetch(BACKEND + url, { method:m, headers:{'Content-Type':'application/json','Authorization':'Bearer '+TOKEN}, body: body?JSON.stringify(body):undefined, credentials:'include' });
    const d = await r.json();
    if (!r.ok) throw new Error(d.error || 'Request failed');
    return d;
  }

  // ‚îÄ‚îÄ PRIVATE KEY MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let _pkEmail = null;
  function showPKModal(pk, email) {
    _pkEmail = email;
    document.getElementById('pk-display').textContent = pk;
    document.getElementById('pk-modal').style.display = 'flex';
    document.getElementById('pk-confirm').checked = false;
    document.getElementById('pk-continue').disabled = true;
  }
  function closePKModal() {
    document.getElementById('pk-modal').style.display = 'none';
    document.getElementById('pk-display').textContent = '‚Äî'; // clear from DOM
    showDash(_pkEmail);
  }
  function copyPK() {
    const pk = document.getElementById('pk-display').textContent;
    navigator.clipboard.writeText(pk).then(() => {
      const btn = document.querySelector('.btn-copy-pk');
      btn.textContent = '‚úÖ Copied!';
      setTimeout(() => btn.textContent = 'üìã Copy Private Key', 2000);
    });
  }

  // ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if (TOKEN) {
    showDash(localStorage.getItem('kf_email'));
  }
</script>
</body>
</html>
